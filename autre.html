<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Personnelle - CS la Colombe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        :root {
            --primary: #3498db; --secondary: #2c3e50; --success: #27ae60;
            --danger: #e74c3c; --warning: #f39c12; --info: #1abc9c;
            --light: #ecf0f1; --dark: #34495e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
        .hidden { display: none !important; }
        
        /* --- Styles Communs --- */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.08); flex-shrink: 0; transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .nav-menu { list-style: none; padding: 1rem 0; margin: 0; }
        .nav-menu li a { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: var(--dark); text-decoration: none; font-weight: 500; }
        .nav-menu li a.active, .nav-menu li a:hover { background: #eaf5fc; color: var(--primary); }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .app-header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .content-area { padding: 2rem; }
        .page { display: none; }
        .page.active { display: block; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        .btn-info { background: var(--info); }
        .btn-sm { padding: 5px 10px; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .form-row { display: flex; gap: 1rem; }
        .alert { padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        
        /* --- Styles spécifiques --- */
        .photo-upload { text-align: center; margin: 1rem 0; }
        .photo-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 1rem; display: block; }
        .photo-placeholder { width: 120px; height: 120px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #999; }
        .file-input { display: none; }
        .upload-btn { background: var(--info); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .currency-input-group { position: relative; }
        .currency-symbol { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666; font-weight: bold; }
        .currency-input { padding-left: 25px; }
        .currency-display { font-weight: bold; color: var(--success); }
        
        /* --- Tabs --- */
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* --- Table styles --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .badge-success { background-color: var(--success); color: white; }
        .badge-warning { background-color: var(--warning); color: white; }
        .badge-danger { background-color: var(--danger); color: white; }
        .badge-info { background-color: var(--info); color: white; }
        .action-buttons { display: flex; gap: 0.5rem; }
        .action-buttons button { padding: 6px 12px; font-size: 0.85rem; }
        
        /* --- Modal styles --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        
        /* --- Styles pour le communiqué --- */
        .communique-preview { background: white; padding: 2rem; border: 1px solid #ddd; font-family: 'Times New Roman', serif; }
        .communique-header { text-align: center; margin-bottom: 2rem; }
        .communique-logo { max-width: 150px; margin-bottom: 1rem; }
        .communique-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
        .communique-date { text-align: right; margin-bottom: 2rem; font-style: italic; }
        .communique-content { line-height: 1.6; }
        .communique-signature { margin-top: 3rem; text-align: right; }
        .signature-line { border-top: 1px solid #000; margin-top: 3rem; width: 300px; margin-left: auto; }
        
        /* --- Styles pour les mois multiples --- */
        .months-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin: 1rem 0; }
        .month-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        
        /* --- Styles pour les fichiers et images --- */
        .file-upload-container { border: 2px dashed #ddd; border-radius: 8px; padding: 2rem; text-align: center; margin: 1rem 0; background: #fafafa; }
        .file-upload-container.dragover { border-color: var(--primary); background: #eaf5fc; }
        .file-preview-container { margin-top: 1.5rem; }
        .file-preview { max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .file-info { margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 5px; font-size: 0.9rem; }
        .file-info span { display: block; margin-bottom: 0.3rem; }
        .uploaded-files-list { margin-top: 1rem; }
        .uploaded-file-item { display: flex; align-items: center; justify-content: space-between; padding: 0.8rem; background: white; border: 1px solid #eee; border-radius: 5px; margin-bottom: 0.5rem; }
        .uploaded-file-info { display: flex; align-items: center; gap: 0.5rem; }
        .file-icon { font-size: 1.2rem; color: var(--primary); }
        .file-actions { display: flex; gap: 0.3rem; }
        
        /* --- Menu toggle pour mobile --- */
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--dark); }
        
        /* --- Pagination --- */
        .pagination { display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        .pagination button { padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; }
        .pagination button.active { background: var(--primary); color: white; }
        
        /* --- Nouveaux styles pour la publication par fichier --- */
        .file-communique-tab { padding: 1.5rem; }
        .file-communique-section { margin-bottom: 1.5rem; }
        .file-selector { display: flex; flex-direction: column; gap: 1rem; }
        .file-type-selector { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .file-type-btn { padding: 10px 20px; border: 2px solid var(--primary); background: white; color: var(--primary); border-radius: 5px; cursor: pointer; font-weight: 500; }
        .file-type-btn.active { background: var(--primary); color: white; }
        .file-preview-area { min-height: 200px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ddd; border-radius: 8px; padding: 2rem; }
        .file-preview-area.has-file { border-color: var(--success); background: #eaf5fc; }
        .preview-image { max-width: 100%; max-height: 300px; border-radius: 5px; }
        .preview-pdf { width: 100%; height: 500px; border: 1px solid #ddd; border-radius: 5px; }
        .communique-file-list { margin-top: 1.5rem; }
        .communique-file-card { border: 1px solid #eee; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white; }
        .communique-file-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .file-stats { display: flex; gap: 1rem; font-size: 0.9rem; color: #666; }
        
        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            .sidebar { position: fixed; z-index: 1000; height: 100%; }
            .main-content { margin-left: 0; }
            .form-row { flex-direction: column; }
            .file-type-selector { flex-direction: column; }
            .file-type-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div style="padding: 1.5rem; text-align: center; border-bottom: 1px solid #eee;">
                <i class="fas fa-cogs" style="font-size: 2rem; color: var(--primary);"></i>
                <h3 style="margin-top: 0.5rem;">Gestion Personnelle</h3>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active" data-page="workers"><i class="fas fa-hard-hat fa-fw"></i> Personnels Ouvriers</a></li>
                <li><a href="#" data-page="communication"><i class="fas fa-bullhorn fa-fw"></i> Communication</a></li>
                <li><a href="#" data-page="salaries"><i class="fas fa-money-check-alt fa-fw"></i> Paiement Salaires</a></li>
                <li><a href="#" data-page="archive"><i class="fas fa-archive fa-fw"></i> Archives</a></li>
                <li><a href="index.html"><i class="fas fa-arrow-left fa-fw"></i> Retour Portail</a></li>
            </ul>
        </nav>
        <div class="main-content">
            <header class="app-header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title">Personnels Ouvriers</h2>
            </header>
            <main class="content-area">
                <div id="global-alert" class="alert hidden"></div>

                <!-- Page: Personnels Ouvriers -->
                <div id="workers-page" class="page active">
                    <div class="card">
                        <h4>Créer un nouveau personnel ouvrier</h4>
                        <form id="worker-form">
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="worker-photo-preview">
                                    <i class="fas fa-user"></i>
                                </div>
                                <input type="file" id="worker-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('worker-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom Complet *</label>
                                    <input type="text" id="worker-name" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance *</label>
                                    <input type="date" id="worker-birthdate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance *</label>
                                    <input type="text" id="worker-birthplace" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe *</label>
                                    <select id="worker-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence *</label>
                                <input type="text" id="worker-address" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Numéro de Téléphone *</label>
                                    <input type="tel" id="worker-phone" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Fonction *</label>
                                    <select id="worker-function" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="Agent de service">Agent de service</option>
                                        <option value="Gardien">Gardien</option>
                                        <option value="Cuisinier">Cuisinier</option>
                                        <option value="Secrétaire">Secrétaire</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Description / Commentaires</label>
                                <textarea id="worker-description" class="form-control" rows="3" placeholder="Informations supplémentaires..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" id="worker-submit-btn">
                                Créer le Personnel
                            </button>
                        </form>
                        
                        <div id="worker-success" class="alert alert-success hidden" style="margin-top: 1rem;">
                            <h4>Personnel créé avec succès !</h4>
                            <p><strong>Matricule:</strong> <span id="worker-matricule"></span></p>
                            <p><strong>Nom:</strong> <span id="worker-fullname"></span></p>
                            <p><strong>Fonction:</strong> <span id="worker-function-display"></span></p>
                            <button class="btn btn-success" onclick="printWorkerCard()">
                                <i class="fas fa-print"></i> Imprimer la Carte
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4>Liste des personnels ouvriers</h4>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <input type="text" id="worker-search" class="form-control" placeholder="Rechercher par matricule, nom ou fonction...">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <select id="worker-status-filter" class="form-control">
                                    <option value="">Tous les statuts</option>
                                    <option value="active">Actif</option>
                                    <option value="inactive">Inactif</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Matricule</th>
                                        <th>Photo</th>
                                        <th>Nom</th>
                                        <th>Fonction</th>
                                        <th>Téléphone</th>
                                        <th>Date d'embauche</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="workers-table-body">
                                    <tr><td colspan="8" style="text-align: center;">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="workers-pagination"></div>
                    </div>
                </div>

                <!-- Page: Communication -->
                <div id="communication-page" class="page">
                    <div class="tabs">
                        <div class="tab active" data-tab="standard">Communiqué Standard</div>
                        <div class="tab" data-tab="file">Publication par Fichier</div>
                    </div>
                    
                    <!-- Onglet: Communiqué Standard -->
                    <div id="standard-tab" class="tab-content active">
                        <div class="card">
                            <h4>Créer un communiqué de paiement</h4>
                            <form id="communique-form">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Type de frais *</label>
                                        <select id="communique-fee-type" class="form-control" required>
                                            <option value="">Sélectionner</option>
                                            <option value="Frais scolaires">Frais scolaires</option>
                                            <option value="Frais de l'état">Frais de l'état</option>
                                            <option value="visite">Visite</option>
                                            <option value="achat pull">Achat pull</option>
                                            <option value="Frais d'inscription">Frais d'inscription</option>
                                            <option value="Autres">Autres (spécifier ci-dessous)</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Autres frais (si autre)</label>
                                        <input type="text" id="communique-other-fee" class="form-control" placeholder="Spécifiez le type de frais">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Date limite de paiement *</label>
                                        <input type="date" id="communique-deadline" class="form-control" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Année scolaire *</label>
                                        <select id="communique-school-year" class="form-control" required>
                                            <option value="">Sélectionner</option>
                                            <option value="2023-2024">2023-2024</option>
                                            <option value="2024-2025">2024-2025</option>
                                            <option value="2025-2026">2025-2026</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Mois concerné *</label>
                                        <select id="communique-month" class="form-control" required>
                                            <option value="">Sélectionner</option>
                                            <option value="janvier">Janvier</option>
                                            <option value="février">Février</option>
                                            <option value="mars">Mars</option>
                                            <option value="avril">Avril</option>
                                            <option value="mai">Mai</option>
                                            <option value="juin">Juin</option>
                                            <option value="juillet">Juillet</option>
                                            <option value="août">Août</option>
                                            <option value="septembre">Septembre</option>
                                            <option value="octobre">Octobre</option>
                                            <option value="novembre">Novembre</option>
                                            <option value="décembre">Décembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Montant du frais ($) *</label>
                                        <div class="currency-input-group">
                                            <span class="currency-symbol">$</span>
                                            <input type="number" id="communique-amount" class="form-control currency-input" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Classes concernées *</label>
                                    <div id="communique-classes-container" class="months-container">
                                        <!-- Les classes seront chargées dynamiquement -->
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Message personnalisé (optionnel)</label>
                                    <textarea id="communique-message" class="form-control" rows="3" placeholder="Ajouter un message personnalisé..."></textarea>
                                </div>
                                
                                <button type="button" class="btn btn-info" onclick="previewCommunique()">
                                    <i class="fas fa-eye"></i> Prévisualiser
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Publier aux parents
                                </button>
                            </form>
                        </div>
                        
                        <div class="card hidden" id="communique-preview-card">
                            <h4>Prévisualisation du communiqué</h4>
                            <div id="communique-preview-content" class="communique-preview">
                                <!-- Contenu généré dynamiquement -->
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <button class="btn btn-success" onclick="printCommunique()">
                                    <i class="fas fa-print"></i> Imprimer le Communiqué
                                </button>
                                <button class="btn btn-secondary" onclick="closePreview()">
                                    Retour à l'édition
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet: Publication par Fichier -->
                    <div id="file-tab" class="tab-content">
                        <div class="card">
                            <h4>Publier un communiqué par fichier ou image</h4>
                            <p>Importez un fichier PDF, image ou document que vous souhaitez partager avec les parents.</p>
                            
                            <div class="file-communique-section">
                                <h5>Sélectionner le type de fichier</h5>
                                <div class="file-type-selector">
                                    <button type="button" class="file-type-btn active" data-file-type="image">
                                        <i class="fas fa-image"></i> Image
                                    </button>
                                    <button type="button" class="file-type-btn" data-file-type="pdf">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </button>
                                    <button type="button" class="file-type-btn" data-file-type="document">
                                        <i class="fas fa-file-word"></i> Document
                                    </button>
                                </div>
                                
                                <div class="file-selector">
                                    <div class="file-upload-container" id="file-drop-zone">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
                                        <h5>Glissez-déposez votre fichier ici</h5>
                                        <p>ou</p>
                                        <button type="button" class="btn btn-primary" onclick="document.getElementById('file-upload-input').click()">
                                            <i class="fas fa-folder-open"></i> Parcourir les fichiers
                                        </button>
                                        <input type="file" id="file-upload-input" class="file-input" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.txt">
                                        <p class="file-info" style="margin-top: 1rem; color: #666;">
                                            <small>Formats acceptés: JPG, PNG, PDF, DOC, DOCX, TXT (Max: 10MB)</small>
                                        </p>
                                    </div>
                                    
                                    <div id="file-preview-container" class="file-preview-container hidden">
                                        <h5>Aperçu du fichier</h5>
                                        <div id="file-preview-area" class="file-preview-area">
                                            <!-- L'aperçu sera inséré ici -->
                                        </div>
                                        <div id="file-info-display" class="file-info">
                                            <!-- Les infos du fichier seront affichées ici -->
                                        </div>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="clearFileSelection()">
                                            <i class="fas fa-times"></i> Supprimer le fichier
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="file-communique-section">
                                <h5>Informations du communiqué</h5>
                                <form id="file-communique-form">
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 1;">
                                            <label>Titre du communiqué *</label>
                                            <input type="text" id="file-communique-title" class="form-control" placeholder="Ex: Rappel paiement frais scolaires" required>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Type de frais *</label>
                                            <select id="file-communique-type" class="form-control" required>
                                                <option value="">Sélectionner</option>
                                                <option value="Frais scolaires">Frais scolaires</option>
                                                <option value="Frais de l'état">Frais de l'état</option>
                                                <option value="visite">Visite</option>
                                                <option value="achat pull">Achat pull</option>
                                                <option value="Frais d'inscription">Frais d'inscription</option>
                                                <option value="Autres">Autres</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 1;">
                                            <label>Date limite de paiement *</label>
                                            <input type="date" id="file-communique-deadline" class="form-control" required>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Année scolaire *</label>
                                            <select id="file-communique-year" class="form-control" required>
                                                <option value="">Sélectionner</option>
                                                <option value="2023-2024">2023-2024</option>
                                                <option value="2024-2025">2024-2025</option>
                                                <option value="2025-2026">2025-2026</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Classes concernées *</label>
                                        <div id="file-communique-classes-container" class="months-container">
                                            <!-- Les classes seront chargées dynamiquement -->
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Description additionnelle (optionnel)</label>
                                        <textarea id="file-communique-description" class="form-control" rows="3" placeholder="Ajoutez une description ou des instructions supplémentaires..."></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Expiration automatique (optionnel)</label>
                                        <div class="form-row">
                                            <div class="form-group" style="flex: 1;">
                                                <select id="file-expiration-type" class="form-control">
                                                    <option value="none">Pas d'expiration</option>
                                                    <option value="days">Jours après la date limite</option>
                                                    <option value="date">Date spécifique</option>
                                                </select>
                                            </div>
                                            <div class="form-group" style="flex: 1;">
                                                <input type="number" id="file-expiration-days" class="form-control hidden" placeholder="Nombre de jours" min="1" value="5">
                                                <input type="date" id="file-expiration-date" class="form-control hidden">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-info" onclick="previewFileCommunique()">
                                        <i class="fas fa-eye"></i> Prévisualiser
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="publish-file-btn">
                                        <i class="fas fa-paper-plane"></i> Publier le fichier
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card hidden" id="file-communique-preview-card">
                            <h4>Prévisualisation du communiqué par fichier</h4>
                            <div id="file-communique-preview-content" style="background: white; padding: 1.5rem; border-radius: 8px;">
                                <!-- Contenu généré dynamiquement -->
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <button class="btn btn-success" onclick="printFileCommunique()">
                                    <i class="fas fa-print"></i> Imprimer l'aperçu
                                </button>
                                <button class="btn btn-secondary" onclick="closeFilePreview()">
                                    Retour à l'édition
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <h5>Gestion des communiqués expirés</h5>
                        <p><small>Les communiqués sont automatiquement supprimés 5 jours après la date limite de paiement.</small></p>
                        <button class="btn btn-warning btn-sm" onclick="cleanupAllExpiredCommuniques()">
                            <i class="fas fa-trash"></i> Nettoyer tous les communiqués expirés
                        </button>
                    </div>
                </div>

                <!-- Page: Paiement Salaires -->
                <div id="salaries-page" class="page">
                    <div class="tabs">
                        <div class="tab active" data-tab="teachers">Paiement Enseignants</div>
                        <div class="tab" data-tab="workers">Paiement Personnels</div>
                    </div>
                    
                    <!-- Onglet: Paiement Enseignants -->
                    <div id="teachers-tab" class="tab-content active">
                        <div class="card">
                            <h4>Paiement des salaires - Enseignants</h4>
                            <form id="teacher-salary-form">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Mois à payer *</label>
                                        <select id="teacher-salary-month" class="form-control" required>
                                            <option value="">Sélectionner</option>
                                            <option value="janvier">Janvier</option>
                                            <option value="février">Février</option>
                                            <option value="mars">Mars</option>
                                            <option value="avril">Avril</option>
                                            <option value="mai">Mai</option>
                                            <option value="juin">Juin</option>
                                            <option value="juillet">Juillet</option>
                                            <option value="août">Août</option>
                                            <option value="septembre">Septembre</option>
                                            <option value="octobre">Octobre</option>
                                            <option value="novembre">Novembre</option>
                                            <option value="décembre">Décembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Matricule enseignant *</label>
                                        <input type="text" id="teacher-matricule" class="form-control" placeholder="Ex: ENS001" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <button type="button" class="btn btn-info" style="margin-top: 28px;" onclick="findTeacher()">
                                            Rechercher
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="teacher-info" class="hidden" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                                    <h5>Informations de l'enseignant</h5>
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 2;">
                                            <label>Nom complet</label>
                                            <input type="text" id="teacher-found-name" class="form-control" readonly>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Type</label>
                                            <input type="text" id="teacher-found-type" class="form-control" readonly>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Classes</label>
                                            <input type="text" id="teacher-found-classes" class="form-control" readonly>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Montant du salaire ($) *</label>
                                        <div class="currency-input-group">
                                            <span class="currency-symbol">$</span>
                                            <input type="number" id="teacher-salary-amount" class="form-control currency-input" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label>Description (optionnel)</label>
                                        <input type="text" id="teacher-salary-description" class="form-control" placeholder="Ex: Salaire régulier + prime">
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    Valider le paiement
                                </button>
                            </form>
                        </div>
                        
                        <div class="card">
                            <h4>Historique des paiements - Enseignants</h4>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <input type="text" id="teacher-salary-search" class="form-control" placeholder="Rechercher par matricule ou nom...">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <select id="teacher-salary-month-filter" class="form-control">
                                        <option value="">Tous les mois</option>
                                        <option value="janvier">Janvier</option>
                                        <option value="février">Février</option>
                                        <option value="mars">Mars</option>
                                        <option value="avril">Avril</option>
                                        <option value="mai">Mai</option>
                                        <option value="juin">Juin</option>
                                        <option value="juillet">Juillet</option>
                                        <option value="août">Août</option>
                                        <option value="septembre">Septembre</option>
                                        <option value="octobre">Octobre</option>
                                        <option value="novembre">Novembre</option>
                                        <option value="décembre">Décembre</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Mois</th>
                                            <th>Montant</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teacher-salaries-table-body"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="teacher-salaries-pagination"></div>
                        </div>
                    </div>
                    
                    <!-- Onglet: Paiement Personnels -->
                    <div id="workers-tab" class="tab-content">
                        <div class="card">
                            <h4>Paiement des salaires - Personnels Ouvriers</h4>
                            <form id="worker-salary-form">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Mois à payer *</label>
                                        <select id="worker-salary-month" class="form-control" required>
                                            <option value="">Sélectionner</option>
                                            <option value="janvier">Janvier</option>
                                            <option value="février">Février</option>
                                            <option value="mars">Mars</option>
                                            <option value="avril">Avril</option>
                                            <option value="mai">Mai</option>
                                            <option value="juin">Juin</option>
                                            <option value="juillet">Juillet</option>
                                            <option value="août">Août</option>
                                            <option value="septembre">Septembre</option>
                                            <option value="octobre">Octobre</option>
                                            <option value="novembre">Novembre</option>
                                            <option value="décembre">Décembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Matricule personnel *</label>
                                        <input type="text" id="worker-salary-matricule" class="form-control" placeholder="Ex: PER001" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <button type="button" class="btn btn-info" style="margin-top: 28px;" onclick="findWorkerForSalary()">
                                            Rechercher
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="worker-salary-info" class="hidden" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                                    <h5>Informations du personnel</h5>
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 2;">
                                            <label>Nom complet</label>
                                            <input type="text" id="worker-found-name" class="form-control" readonly>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Fonction</label>
                                            <input type="text" id="worker-found-function" class="form-control" readonly>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Téléphone</label>
                                            <input type="text" id="worker-found-phone" class="form-control" readonly>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Montant du salaire ($) *</label>
                                        <div class="currency-input-group">
                                            <span class="currency-symbol">$</span>
                                            <input type="number" id="worker-salary-amount" class="form-control currency-input" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label>Description (optionnel)</label>
                                        <input type="text" id="worker-salary-description" class="form-control" placeholder="Ex: Salaire régulier">
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    Valider le paiement
                                </button>
                            </form>
                        </div>
                        
                        <div class="card">
                            <h4>Historique des paiements - Personnels</h4>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <input type="text" id="worker-salary-search" class="form-control" placeholder="Rechercher par matricule ou nom...">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <select id="worker-salary-month-filter" class="form-control">
                                        <option value="">Tous les mois</option>
                                        <option value="janvier">Janvier</option>
                                        <option value="février">Février</option>
                                        <option value="mars">Mars</option>
                                        <option value="avril">Avril</option>
                                        <option value="mai">Mai</option>
                                        <option value="juin">Juin</option>
                                        <option value="juillet">Juillet</option>
                                        <option value="août">Août</option>
                                        <option value="septembre">Septembre</option>
                                        <option value="octobre">Octobre</option>
                                        <option value="novembre">Novembre</option>
                                        <option value="décembre">Décembre</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Mois</th>
                                            <th>Montant</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="worker-salaries-table-body"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="worker-salaries-pagination"></div>
                        </div>
                    </div>
                </div>

                <!-- Page: Archives -->
                <div id="archive-page" class="page">
                    <div class="tabs">
                        <div class="tab active" data-tab="communiques">Communiqués</div>
                        <div class="tab" data-tab="file-communiques">Communiqués par Fichier</div>
                        <div class="tab" data-tab="salaries">Paiements Salaires</div>
                    </div>
                    
                    <!-- Onglet: Archives Communiqués Standard -->
                    <div id="communiques-tab" class="tab-content active">
                        <div class="card">
                            <h4>Archives - Communiqués publiés</h4>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <input type="text" id="archive-search" class="form-control" placeholder="Rechercher par type de frais ou mois...">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <select id="archive-fee-filter" class="form-control">
                                        <option value="">Tous les frais</option>
                                        <option value="Frais scolaires">Frais scolaires</option>
                                        <option value="Frais de l'état">Frais de l'état</option>
                                        <option value="visite">Visite</option>
                                        <option value="achat pull">Achat pull</option>
                                        <option value="Frais d'inscription">Frais d'inscription</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <select id="archive-year-filter" class="form-control">
                                        <option value="">Toutes les années</option>
                                        <option value="2023-2024">2023-2024</option>
                                        <option value="2024-2025">2024-2025</option>
                                        <option value="2025-2026">2025-2026</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type de frais</th>
                                            <th>Mois</th>
                                            <th>Année scolaire</th>
                                            <th>Classes concernées</th>
                                            <th>Montant</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="archive-table-body"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="archive-pagination"></div>
                        </div>
                    </div>
                    
                    <!-- Onglet: Archives Communiqués par Fichier -->
                    <div id="file-communiques-tab" class="tab-content">
                        <div class="card">
                            <h4>Archives - Communiqués par Fichier</h4>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <input type="text" id="file-archive-search" class="form-control" placeholder="Rechercher par titre ou type...">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <select id="file-archive-type-filter" class="form-control">
                                        <option value="">Tous les types</option>
                                        <option value="image">Images</option>
                                        <option value="pdf">PDF</option>
                                        <option value="document">Documents</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <select id="file-archive-year-filter" class="form-control">
                                        <option value="">Toutes les années</option>
                                        <option value="2023-2024">2023-2024</option>
                                        <option value="2024-2025">2024-2025</option>
                                        <option value="2025-2026">2025-2026</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Titre</th>
                                            <th>Type de fichier</th>
                                            <th>Type de frais</th>
                                            <th>Année scolaire</th>
                                            <th>Classes concernées</th>
                                            <th>Taille</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="file-archive-table-body"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="file-archive-pagination"></div>
                        </div>
                    </div>
                    
                    <!-- Onglet: Archives Paiements Salaires -->
                    <div id="salaries-tab" class="tab-content">
                        <div class="card">
                            <h4>Archives - Paiements de salaires</h4>
                            <div class="tabs">
                                <div class="tab active" data-tab="archive-teachers">Enseignants</div>
                                <div class="tab" data-tab="archive-workers">Personnels</div>
                            </div>
                            
                            <div id="archive-teachers-tab" class="tab-content active">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <input type="text" id="archive-teacher-search" class="form-control" placeholder="Rechercher par matricule ou nom...">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <select id="archive-teacher-month-filter" class="form-control">
                                            <option value="">Tous les mois</option>
                                            <option value="janvier">Janvier</option>
                                            <option value="février">Février</option>
                                            <option value="mars">Mars</option>
                                            <option value="avril">Avril</option>
                                            <option value="mai">Mai</option>
                                            <option value="juin">Juin</option>
                                            <option value="juillet">Juillet</option>
                                            <option value="août">Août</option>
                                            <option value="septembre">Septembre</option>
                                            <option value="octobre">Octobre</option>
                                            <option value="novembre">Novembre</option>
                                            <option value="décembre">Décembre</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Matricule</th>
                                                <th>Nom</th>
                                                <th>Mois</th>
                                                <th>Montant</th>
                                                <th>Type</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="archive-teachers-table-body"></tbody>
                                    </table>
                                </div>
                                <div class="pagination" id="archive-teachers-pagination"></div>
                            </div>
                            
                            <div id="archive-workers-tab" class="tab-content">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <input type="text" id="archive-worker-search" class="form-control" placeholder="Rechercher par matricule ou nom...">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <select id="archive-worker-month-filter" class="form-control">
                                            <option value="">Tous les mois</option>
                                            <option value="janvier">Janvier</option>
                                            <option value="février">Février</option>
                                            <option value="mars">Mars</option>
                                            <option value="avril">Avril</option>
                                            <option value="mai">Mai</option>
                                            <option value="juin">Juin</option>
                                            <option value="juillet">Juillet</option>
                                            <option value="août">Août</option>
                                            <option value="septembre">Septembre</option>
                                            <option value="octobre">Octobre</option>
                                            <option value="novembre">Novembre</option>
                                            <option value="décembre">Décembre</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Mois</th>
                                            <th>Montant</th>
                                            <th>Fonction</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="archive-workers-table-body"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="archive-workers-pagination"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal pour l'impression de bordereau -->
            <div id="salary-receipt-modal" class="modal hidden">
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Bordereau de paiement de salaire</h3>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div id="salary-receipt-content">
                        <!-- Contenu généré dynamiquement -->
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button id="print-salary-receipt-btn" class="btn btn-primary">Imprimer le bordereau</button>
                        <button id="back-salary-receipt-btn" class="btn btn-secondary">Retour</button>
                    </div>
                </div>
            </div>

            <!-- Modal pour la carte du personnel -->
            <div id="worker-card-modal" class="modal hidden">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Carte d'identification du personnel</h3>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div id="worker-card-content">
                        <!-- Contenu généré dynamiquement -->
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button id="print-worker-card-btn" class="btn btn-primary">Imprimer la carte</button>
                        <button id="back-worker-card-btn" class="btn btn-secondary">Fermer</button>
                    </div>
                </div>
            </div>
            
            <!-- Modal pour prévisualiser le fichier -->
            <div id="file-preview-modal" class="modal hidden">
                <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
                    <div class="modal-header">
                        <h3 id="file-preview-title">Prévisualisation du fichier</h3>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div id="file-preview-content" style="max-height: 70vh; overflow-y: auto;">
                        <!-- Contenu du fichier sera inséré ici -->
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button id="download-file-btn" class="btn btn-primary">
                            <i class="fas fa-download"></i> Télécharger
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal('file-preview-modal')">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script type="module">
    // 1. INITIALISATION DE FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, serverTimestamp, query, where, orderBy, limit, writeBatch, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // CONFIGURATION FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBn7VIddclO7KtrXb5sibCr9SjVLjOy-qI",
        authDomain: "theo1d.firebaseapp.com",
        projectId: "theo1d",
        storageBucket: "theo1d.firebasestorage.app",
        messagingSenderId: "269629842962",
        appId: "1:269629842962:web:a80a12b04448fe1e595acb",
        measurementId: "G-TNSG1XFMDZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 2. FONCTION UPLOAD CLOUDINARY (optimisée)
    const CLOUDINARY_CONFIG = {
        cloudName: 'diwn8sxtn',
        uploadPreset: 'cs_lacolombe'
    };

    async function uploadToCloudinary(file, folder = 'cs-lacolombe') {
        if (!file) return null;
        
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                    formData.append('folder', folder);
                    
                    const response = await fetch(
                        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`,
                        { 
                            method: 'POST', 
                            body: formData 
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    resolve(data.secure_url);
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
            reader.readAsDataURL(file);
        });
    }

    // 3. FONCTION UPLOAD DE FICHIER GÉNÉRIQUE (support PDF, images, documents)
    async function uploadFileToCloudinary(file, folder = 'cs-lacolombe/communiques') {
        if (!file) return null;
        
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                    formData.append('folder', folder);
                    
                    // Déterminer le type de ressource
                    let resourceType = 'auto'; // Cloudinary détecte automatiquement
                    if (file.type.includes('pdf')) {
                        resourceType = 'raw'; // Pour PDF
                    } else if (file.type.includes('image')) {
                        resourceType = 'image';
                    } else if (file.type.includes('text') || file.type.includes('document')) {
                        resourceType = 'raw'; // Pour documents
                    }
                    
                    formData.append('resource_type', resourceType);
                    
                    const response = await fetch(
                        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/${resourceType}/upload`,
                        { 
                            method: 'POST', 
                            body: formData 
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    resolve({
                        url: data.secure_url,
                        publicId: data.public_id,
                        format: data.format,
                        resourceType: data.resource_type,
                        size: data.bytes,
                        width: data.width,
                        height: data.height
                    });
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
            reader.readAsDataURL(file);
        });
    }

    // 4. VARIABLES GLOBALES
    let currentUser = null;
    let workerPhotoFile = null;
    let communiqueFile = null;
    let filePreviewData = null;
    let cache = {
        workers: [],
        teacherSalaries: [],
        workerSalaries: [],
        communiques: [],
        fileCommuniques: [],
        teachers: [],
        classes: []
    };

    // 5. GESTION DE L'AUTHENTIFICATION
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            await initializeAppData();
        } else {
            window.location.href = 'index.html';
        }
    });

    // 6. FONCTIONS UTILITAIRES
    function showAlert(message, type = 'info') {
        const alertBox = document.getElementById('global-alert');
        alertBox.textContent = message;
        alertBox.className = `alert alert-${type}`;
        alertBox.classList.remove('hidden');
        setTimeout(() => alertBox.classList.add('hidden'), 6000);
    }

    function formatDate(date) {
        if (!date) return 'Non définie';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString('fr-FR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 7. INITIALISATION DES DONNÉES
    async function initializeAppData() {
        await loadWorkers();
        await loadTeacherSalaries();
        await loadWorkerSalaries();
        await loadCommuniques();
        await loadFileCommuniques();
        await loadClassesForCommunique();
        setupFileUpload();
    }

    // 8. GESTION DES FICHIERS - DRAG AND DROP
    function setupFileUpload() {
        const dropZone = document.getElementById('file-drop-zone');
        const fileInput = document.getElementById('file-upload-input');
        
        // Drag and drop events
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelection(files[0]);
            }
        });
        
        // File input change event
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });
        
        // Gestion des boutons de type de fichier
        document.querySelectorAll('.file-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.file-type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const fileType = btn.dataset.fileType;
                let acceptTypes = '';
                
                switch(fileType) {
                    case 'image':
                        acceptTypes = '.jpg,.jpeg,.png,.gif,.bmp,.webp';
                        break;
                    case 'pdf':
                        acceptTypes = '.pdf';
                        break;
                    case 'document':
                        acceptTypes = '.doc,.docx,.txt,.rtf';
                        break;
                }
                
                fileInput.accept = acceptTypes;
            });
        });
        
        // Gestion du sélecteur d'expiration
        const expirationType = document.getElementById('file-expiration-type');
        const expirationDays = document.getElementById('file-expiration-days');
        const expirationDate = document.getElementById('file-expiration-date');
        
        expirationType.addEventListener('change', () => {
            expirationDays.classList.add('hidden');
            expirationDate.classList.add('hidden');
            
            if (expirationType.value === 'days') {
                expirationDays.classList.remove('hidden');
            } else if (expirationType.value === 'date') {
                expirationDate.classList.remove('hidden');
            }
        });
    }

    // 9. GESTION DE LA SÉLECTION DE FICHIER
    function handleFileSelection(file) {
        // Validation du fichier
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            showAlert("Le fichier est trop volumineux. Maximum 10MB.", "error");
            return;
        }
        
        // Types acceptés
        const acceptedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 
                              'application/pdf', 'application/msword', 
                              'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                              'text/plain', 'text/rtf'];
        
        if (!acceptedTypes.includes(file.type)) {
            showAlert("Type de fichier non supporté.", "error");
            return;
        }
        
        communiqueFile = file;
        filePreviewData = {
            name: file.name,
            size: file.size,
            type: file.type,
            lastModified: new Date(file.lastModified).toLocaleDateString('fr-FR')
        };
        
        // Afficher l'aperçu
        displayFilePreview(file);
        
        // Afficher les informations du fichier
        const fileInfo = document.getElementById('file-info-display');
        fileInfo.innerHTML = `
            <span><strong>Nom:</strong> ${file.name}</span>
            <span><strong>Taille:</strong> ${formatFileSize(file.size)}</span>
            <span><strong>Type:</strong> ${file.type}</span>
            <span><strong>Modifié:</strong> ${new Date(file.lastModified).toLocaleDateString('fr-FR')}</span>
        `;
        
        // Afficher le conteneur de prévisualisation
        document.getElementById('file-preview-container').classList.remove('hidden');
    }

    // 10. AFFICHAGE DE L'APERÇU DU FICHIER
    function displayFilePreview(file) {
        const previewArea = document.getElementById('file-preview-area');
        previewArea.innerHTML = '';
        previewArea.classList.add('has-file');
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewArea.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="Aperçu de l'image">`;
            };
            reader.readAsDataURL(file);
        } else if (file.type === 'application/pdf') {
            previewArea.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-file-pdf" style="font-size: 4rem; color: #e74c3c;"></i>
                    <p style="margin-top: 1rem;"><strong>${file.name}</strong></p>
                    <p>PDF - ${formatFileSize(file.size)}</p>
                </div>
            `;
        } else if (file.type.includes('document') || file.type.includes('text')) {
            previewArea.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-file-word" style="font-size: 4rem; color: #3498db;"></i>
                    <p style="margin-top: 1rem;"><strong>${file.name}</strong></p>
                    <p>Document - ${formatFileSize(file.size)}</p>
                </div>
            `;
        }
    }

    // 11. EFFACER LA SÉLECTION DE FICHIER
    window.clearFileSelection = function() {
        communiqueFile = null;
        filePreviewData = null;
        document.getElementById('file-preview-container').classList.add('hidden');
        document.getElementById('file-upload-input').value = '';
        document.getElementById('file-preview-area').innerHTML = '';
        document.getElementById('file-preview-area').classList.remove('has-file');
    };

    // 12. CHARGEMENT DES CLASSES POUR LES COMMUNIQUÉS PAR FICHIER
    async function loadClassesForFileCommunique() {
        const container = document.getElementById('file-communique-classes-container');
        container.innerHTML = 'Chargement des classes...';
        
        try {
            // Charger toutes les classes
            const [classesSnap, primaryClassesSnap, kindergartenClassesSnap] = await Promise.all([
                getDocs(collection(db, 'classes')),
                getDocs(collection(db, 'primary_classes')),
                getDocs(collection(db, 'kindergarten_classes'))
            ]);
            
            let html = '';
            
            classesSnap.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="month-checkbox">
                        <input type="checkbox" id="file-class-${doc.id}" value="${data.name}" class="file-class-checkbox">
                        <label for="file-class-${doc.id}">${data.name} (Sec)</label>
                    </div>
                `;
            });
            
            primaryClassesSnap.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="month-checkbox">
                        <input type="checkbox" id="file-primary-class-${doc.id}" value="${data.name}" class="file-class-checkbox">
                        <label for="file-primary-class-${doc.id}">${data.name} (Prim)</label>
                    </div>
                `;
            });
            
            kindergartenClassesSnap.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="month-checkbox">
                        <input type="checkbox" id="file-kindergarten-class-${doc.id}" value="${data.name}" class="file-class-checkbox">
                        <label for="file-kindergarten-class-${doc.id}">${data.name} (Mat)</label>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p>Aucune classe disponible</p>';
            
        } catch (error) {
            console.error("Erreur chargement classes:", error);
            container.innerHTML = 'Erreur de chargement';
        }
    }

    // 13. PRÉVISUALISATION DU COMMUNIQUÉ PAR FICHIER
    window.previewFileCommunique = function() {
        const title = document.getElementById('file-communique-title').value;
        const feeType = document.getElementById('file-communique-type').value;
        const deadline = document.getElementById('file-communique-deadline').value;
        const schoolYear = document.getElementById('file-communique-year').value;
        const description = document.getElementById('file-communique-description').value;
        
        // Récupérer les classes sélectionnées
        const selectedClasses = [];
        document.querySelectorAll('#file-communique-classes-container .file-class-checkbox:checked').forEach(checkbox => {
            selectedClasses.push(checkbox.value);
        });
        
        if (!title || !feeType || !deadline || !schoolYear || selectedClasses.length === 0 || !communiqueFile) {
            showAlert("Veuillez remplir tous les champs obligatoires et sélectionner un fichier", "error");
            return;
        }
        
        // Formatage de la date
        const deadlineDate = new Date(deadline);
        const formattedDeadline = deadlineDate.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        const today = new Date();
        const formattedToday = today.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        // Construction du communiqué
        const previewHTML = `
            <div style="font-family: 'Times New Roman', serif; line-height: 1.6;">
                <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid var(--primary); padding-bottom: 1rem;">
                    <h2 style="color: var(--primary); margin-bottom: 0.5rem;">COMMUNIQUE DE PAIEMENT</h2>
                    <h3>${title}</h3>
                    <p>Complexe Scolaire la Colombe</p>
                    <p>Lubumbashi, République Démocratique du Congo</p>
                </div>
                
                <div style="text-align: right; margin-bottom: 2rem; font-style: italic;">
                    Lubumbashi, le ${formattedToday}
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h4>Détails du fichier joint :</h4>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                        <p><strong>Nom du fichier :</strong> ${communiqueFile.name}</p>
                        <p><strong>Type :</strong> ${communiqueFile.type}</p>
                        <p><strong>Taille :</strong> ${formatFileSize(communiqueFile.size)}</p>
                        ${communiqueFile.type.startsWith('image/') ? 
                            `<p><strong>Aperçu :</strong></p>
                            <div style="text-align: center; margin: 1rem 0;">
                                <img src="${URL.createObjectURL(communiqueFile)}" style="max-width: 300px; max-height: 200px; border-radius: 5px;">
                            </div>` : 
                            `<p><i class="fas fa-file-alt" style="font-size: 3rem; color: var(--primary);"></i></p>`
                        }
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h4>Informations du communiqué :</h4>
                    <p><strong>Type de frais :</strong> ${feeType}</p>
                    <p><strong>Année scolaire :</strong> ${schoolYear}</p>
                    <p><strong>Date limite de paiement :</strong> ${formattedDeadline}</p>
                    <p><strong>Classes concernées :</strong> ${selectedClasses.join(', ')}</p>
                    ${description ? `<p><strong>Description :</strong> ${description}</p>` : ''}
                </div>
                
                <div style="border-top: 1px solid #ddd; padding-top: 2rem; margin-top: 2rem;">
                    <p style="text-align: right;">
                        <strong>La Direction</strong><br>
                        Complexe Scolaire la Colombe
                    </p>
                </div>
            </div>
        `;
        
        document.getElementById('file-communique-preview-content').innerHTML = previewHTML;
        document.getElementById('file-communique-preview-card').classList.remove('hidden');
        document.getElementById('file-communique-form').style.display = 'none';
    };

    // 14. PUBLICATION DU COMMUNIQUÉ PAR FICHIER
    document.getElementById('file-communique-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('file-communique-title').value;
        const feeType = document.getElementById('file-communique-type').value;
        const deadline = document.getElementById('file-communique-deadline').value;
        const schoolYear = document.getElementById('file-communique-year').value;
        const description = document.getElementById('file-communique-description').value;
        const expirationType = document.getElementById('file-expiration-type').value;
        const expirationDays = document.getElementById('file-expiration-days').value;
        const expirationDate = document.getElementById('file-expiration-date').value;
        
        // Récupérer les classes sélectionnées
        const selectedClasses = [];
        document.querySelectorAll('#file-communique-classes-container .file-class-checkbox:checked').forEach(checkbox => {
            selectedClasses.push(checkbox.value);
        });
        
        if (!title || !feeType || !deadline || !schoolYear || selectedClasses.length === 0 || !communiqueFile) {
            showAlert("Veuillez remplir tous les champs obligatoires", "error");
            return;
        }
        
        const publishBtn = document.getElementById('publish-file-btn');
        const originalText = publishBtn.innerHTML;
        
        try {
            publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publication en cours...';
            publishBtn.disabled = true;
            
            // 1. Upload du fichier vers Cloudinary
            showAlert("Upload du fichier en cours...", "info");
            const uploadResult = await uploadFileToCloudinary(communiqueFile, `communiques/${schoolYear}`);
            
            if (!uploadResult || !uploadResult.url) {
                throw new Error("Échec de l'upload du fichier");
            }
            
            // 2. Calculer la date d'expiration
            let expirationDateValue = null;
            const deadlineDate = new Date(deadline);
            
            if (expirationType === 'days' && expirationDays) {
                const expiration = new Date(deadlineDate);
                expiration.setDate(expiration.getDate() + parseInt(expirationDays));
                expirationDateValue = expiration.toISOString();
            } else if (expirationType === 'date' && expirationDate) {
                expirationDateValue = new Date(expirationDate).toISOString();
            } else if (expirationType === 'none') {
                // Pas d'expiration
                expirationDateValue = null;
            } else {
                // Expiration par défaut: 5 jours après la date limite
                const defaultExpiration = new Date(deadlineDate);
                defaultExpiration.setDate(defaultExpiration.getDate() + 5);
                expirationDateValue = defaultExpiration.toISOString();
            }
            
            // 3. Créer le communiqué dans Firestore
            const fileCommuniqueData = {
                title: title,
                feeType: feeType,
                deadline: deadline,
                schoolYear: schoolYear,
                description: description,
                classes: selectedClasses,
                fileUrl: uploadResult.url,
                fileName: communiqueFile.name,
                fileType: communiqueFile.type,
                fileSize: communiqueFile.size,
                fileFormat: uploadResult.format,
                resourceType: uploadResult.resourceType,
                publishedBy: currentUser.uid,
                publishedAt: serverTimestamp(),
                expirationDate: expirationDateValue,
                status: 'published'
            };
            
            const docRef = await addDoc(collection(db, 'file_communiques'), fileCommuniqueData);
            
            // 4. Associer le communiqué aux parents concernés
            await associateFileCommuniqueToParents(docRef.id, fileCommuniqueData);
            
            // 5. Ajouter au cache
            cache.fileCommuniques.push({ id: docRef.id, ...fileCommuniqueData });
            
            showAlert(`Communiqué publié avec succès ! Fichier: ${communiqueFile.name}`, 'success');
            
            // 6. Réinitialiser le formulaire
            document.getElementById('file-communique-form').reset();
            clearFileSelection();
            closeFilePreview();
            
            // 7. Mettre à jour l'affichage
            if (document.getElementById('file-archive-table-body')) {
                displayFileCommuniques(cache.fileCommuniques);
                setupPagination(cache.fileCommuniques, 'file-archive-pagination');
            }
            
        } catch (error) {
            console.error('Erreur publication communiqué par fichier:', error);
            showAlert('Erreur lors de la publication: ' + error.message, 'error');
        } finally {
            publishBtn.innerHTML = originalText;
            publishBtn.disabled = false;
        }
    });

    // 15. ASSOCIER LE COMMUNIQUÉ PAR FICHIER AUX PARENTS
    async function associateFileCommuniqueToParents(communiqueId, communiqueData) {
        try {
            // 1. Récupérer tous les parents
            const parentsSnap = await getDocs(collection(db, 'parents'));
            
            // 2. Pour chaque parent, vérifier si leurs enfants sont concernés
            for (const parentDoc of parentsSnap.docs) {
                const parentData = parentDoc.data();
                const parentChildren = parentData.children || [];
                
                // 3. Vérifier si ce parent a des enfants dans les classes concernées
                const concernedChildren = [];
                
                for (const child of parentChildren) {
                    // Vérifier si l'enfant est dans une classe concernée
                    if (communiqueData.classes.includes(child.class)) {
                        concernedChildren.push({
                            matricule: child.matricule,
                            name: child.fullName || child.name,
                            class: child.class
                        });
                    }
                }
                
                // 4. Si le parent a des enfants concernés, créer une relation
                if (concernedChildren.length > 0) {
                    const relationData = {
                        communiqueId: communiqueId,
                        parentId: parentDoc.id,
                        parentName: parentData.fullName,
                        parentEmail: parentData.email,
                        studentIds: concernedChildren.map(child => child.matricule),
                        studentNames: concernedChildren.map(child => child.name),
                        studentClasses: concernedChildren.map(child => child.class),
                        title: communiqueData.title,
                        feeType: communiqueData.feeType,
                        fileUrl: communiqueData.fileUrl,
                        fileName: communiqueData.fileName,
                        deadline: communiqueData.deadline,
                        expirationDate: communiqueData.expirationDate,
                        createdAt: serverTimestamp(),
                        status: 'pending'
                    };
                    
                    await addDoc(collection(db, 'parent_file_communique_relations'), relationData);
                    
                    // 5. Créer aussi une notification
                    const notificationData = {
                        parentId: parentDoc.id,
                        type: 'file_communique',
                        title: 'Nouveau communiqué par fichier',
                        body: `Un nouveau communiqué "${communiqueData.title}" a été publié pour ${concernedChildren.length} de vos enfants`,
                        data: {
                            communiqueId: communiqueId,
                            fileUrl: communiqueData.fileUrl,
                            fileName: communiqueData.fileName,
                            feeType: communiqueData.feeType,
                            deadline: communiqueData.deadline
                        },
                        read: false,
                        createdAt: serverTimestamp()
                    };
                    
                    await addDoc(collection(db, 'notifications'), notificationData);
                }
            }
            
            console.log(`✅ Communiqué ${communiqueId} associé aux parents concernés`);
            
        } catch (error) {
            console.error('❌ Erreur association communiqué aux parents:', error);
            throw error;
        }
    }

    // 16. FERMETURE DE LA PRÉVISUALISATION FICHIER
    window.closeFilePreview = function() {
        document.getElementById('file-communique-preview-card').classList.add('hidden');
        document.getElementById('file-communique-form').style.display = 'block';
    };

    // 17. IMPRESSION DU COMMUNIQUÉ PAR FICHIER
    window.printFileCommunique = function() {
        const previewContent = document.getElementById('file-communique-preview-content').innerHTML;
        const printWindow = window.open('', '_blank');
        
        const printHTML = `
            <!DOCTYPE html>
            <html>
                <head>
                    <title>Communiqué par Fichier - CS la Colombe</title>
                    <style>
                        body { 
                            font-family: 'Times New Roman', serif; 
                            margin: 40px; 
                            font-size: 14px;
                            line-height: 1.6;
                        }
                        h2, h3, h4 { color: #3498db; }
                        .header { 
                            text-align: center; 
                            margin-bottom: 30px; 
                            border-bottom: 2px solid #3498db;
                            padding-bottom: 20px;
                        }
                        .file-info { 
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 5px;
                            margin: 20px 0;
                        }
                        .signature { 
                            margin-top: 100px; 
                            text-align: right; 
                        }
                        .signature-line { 
                            border-top: 1px solid #000; 
                            margin-top: 50px; 
                            width: 300px; 
                            margin-left: auto; 
                        }
                        @media print {
                            body { margin: 20px; }
                        }
                    </style>
                </head>
                <body>
                    ${previewContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 1000);
                        }
                    <\/script>
                </body>
            </html>
        `;
        
        printWindow.document.write(printHTML);
        printWindow.document.close();
    };

    // 18. CHARGEMENT DES COMMUNIQUÉS PAR FICHIER
    async function loadFileCommuniques() {
        try {
            const fileCommuniquesSnap = await getDocs(collection(db, 'file_communiques'));
            cache.fileCommuniques = [];
            fileCommuniquesSnap.forEach(doc => {
                cache.fileCommuniques.push({ id: doc.id, ...doc.data() });
            });
            
            // Trier par date (plus récent d'abord)
            cache.fileCommuniques.sort((a, b) => {
                const dateA = a.publishedAt?.toDate() || new Date(0);
                const dateB = b.publishedAt?.toDate() || new Date(0);
                return dateB - dateA;
            });
            
            // Afficher dans les archives si la page est active
            if (document.getElementById('file-archive-table-body')) {
                displayFileCommuniques(cache.fileCommuniques);
                setupPagination(cache.fileCommuniques, 'file-archive-pagination');
                setupFileCommuniqueSearch();
            }
            
        } catch (error) {
            console.error("Erreur chargement communiqués par fichier:", error);
        }
    }

    // 19. AFFICHAGE DES COMMUNIQUÉS PAR FICHIER
    function displayFileCommuniques(communiques) {
        const tableBody = document.getElementById('file-archive-table-body');
        
        if (communiques.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Aucun communiqué par fichier publié.</td></tr>';
            return;
        }
        
        let html = '';
        communiques.forEach(data => {
            const publishedDate = data.publishedAt ? 
                new Date(data.publishedAt.toDate()).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Date inconnue';
            
            // Déterminer l'icône selon le type de fichier
            let fileIcon = 'fa-file';
            let fileTypeText = 'Document';
            
            if (data.fileType.includes('image')) {
                fileIcon = 'fa-file-image';
                fileTypeText = 'Image';
            } else if (data.fileType.includes('pdf')) {
                fileIcon = 'fa-file-pdf';
                fileTypeText = 'PDF';
            } else if (data.fileType.includes('text') || data.fileType.includes('document')) {
                fileIcon = 'fa-file-word';
                fileTypeText = 'Document';
            }
            
            // Vérifier si expiré
            const isExpired = data.expirationDate && new Date(data.expirationDate) < new Date();
            const statusBadge = isExpired ? 
                '<span class="badge badge-danger">Expiré</span>' : 
                '<span class="badge badge-success">Actif</span>';
            
            html += `
                <tr>
                    <td>${publishedDate}</td>
                    <td><strong>${data.title}</strong></td>
                    <td><i class="fas ${fileIcon}"></i> ${fileTypeText}</td>
                    <td>${data.feeType}</td>
                    <td>${data.schoolYear}</td>
                    <td>${data.classes?.join(', ') || ''}</td>
                    <td>${formatFileSize(data.fileSize)}</td>
                    <td>${statusBadge}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="previewFileInModal('${data.id}')">
                            <i class="fas fa-eye"></i> Voir
                        </button>
                        <button class="btn btn-info btn-sm" onclick="downloadFile('${data.fileUrl}', '${data.fileName}')">
                            <i class="fas fa-download"></i> Télécharger
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFileCommunique('${data.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
    }

    // 20. RECHERCHE DES COMMUNIQUÉS PAR FICHIER
    function setupFileCommuniqueSearch() {
        const searchInput = document.getElementById('file-archive-search');
        const typeFilter = document.getElementById('file-archive-type-filter');
        const yearFilter = document.getElementById('file-archive-year-filter');
        
        const updateTable = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const type = typeFilter.value;
            const year = yearFilter.value;
            
            let filtered = cache.fileCommuniques;
            
            if (searchTerm) {
                filtered = filtered.filter(com => 
                    com.title?.toLowerCase().includes(searchTerm) ||
                    com.feeType?.toLowerCase().includes(searchTerm) ||
                    com.description?.toLowerCase().includes(searchTerm)
                );
            }
            
            if (type) {
                if (type === 'image') {
                    filtered = filtered.filter(com => com.fileType?.includes('image'));
                } else if (type === 'pdf') {
                    filtered = filtered.filter(com => com.fileType?.includes('pdf'));
                } else if (type === 'document') {
                    filtered = filtered.filter(com => 
                        com.fileType?.includes('text') || 
                        com.fileType?.includes('document') ||
                        com.fileType?.includes('word')
                    );
                }
            }
            
            if (year) {
                filtered = filtered.filter(com => com.schoolYear === year);
            }
            
            displayFileCommuniques(filtered);
            setupPagination(filtered, 'file-archive-pagination');
        };
        
        searchInput.addEventListener('input', updateTable);
        typeFilter.addEventListener('change', updateTable);
        yearFilter.addEventListener('change', updateTable);
    }

    // 21. PRÉVISUALISATION DU FICHIER DANS UN MODAL
    window.previewFileInModal = async function(communiqueId) {
        const communique = cache.fileCommuniques.find(c => c.id === communiqueId);
        if (!communique) {
            showAlert('Communiqué non trouvé.', 'error');
            return;
        }
        
        document.getElementById('file-preview-title').textContent = communique.title;
        const previewContent = document.getElementById('file-preview-content');
        
        // Afficher un message de chargement
        previewContent.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>Chargement du fichier...</p>
            </div>
        `;
        
        // Afficher le modal
        document.getElementById('file-preview-modal').classList.remove('hidden');
        
        // Configurer le bouton de téléchargement
        document.getElementById('download-file-btn').onclick = () => {
            downloadFile(communique.fileUrl, communique.fileName);
        };
        
        // Afficher le contenu selon le type de fichier
        if (communique.fileType.includes('image')) {
            previewContent.innerHTML = `
                <div style="text-align: center;">
                    <img src="${communique.fileUrl}" style="max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="margin-top: 1rem;">
                        <p><strong>${communique.title}</strong></p>
                        <p><small>${communique.feeType} - ${communique.schoolYear}</small></p>
                        <p><small>Classes: ${communique.classes?.join(', ')}</small></p>
                    </div>
                </div>
            `;
        } else if (communique.fileType.includes('pdf')) {
            previewContent.innerHTML = `
                <div style="width: 100%; height: 60vh;">
                    <iframe src="${communique.fileUrl}" width="100%" height="100%" style="border: none; border-radius: 8px;"></iframe>
                </div>
                <div style="margin-top: 1rem;">
                    <p><strong>${communique.title}</strong></p>
                    <p><small>${communique.feeType} - ${communique.schoolYear}</small></p>
                    <p><small>Classes: ${communique.classes?.join(', ')}</small></p>
                    ${communique.description ? `<p><small>Description: ${communique.description}</small></p>` : ''}
                </div>
            `;
        } else {
            previewContent.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-file-alt fa-4x" style="color: var(--primary);"></i>
                    <h4 style="margin-top: 1rem;">${communique.title}</h4>
                    <p><strong>Type de fichier:</strong> ${communique.fileType}</p>
                    <p><strong>Taille:</strong> ${formatFileSize(communique.fileSize)}</p>
                    <p><strong>Type de frais:</strong> ${communique.feeType}</p>
                    <p><strong>Année scolaire:</strong> ${communique.schoolYear}</p>
                    <p><strong>Classes concernées:</strong> ${communique.classes?.join(', ')}</p>
                    ${communique.description ? `<p><strong>Description:</strong> ${communique.description}</p>` : ''}
                    <div style="margin-top: 2rem;">
                        <p>Ce document doit être téléchargé pour être consulté.</p>
                        <button class="btn btn-primary" onclick="downloadFile('${communique.fileUrl}', '${communique.fileName}')">
                            <i class="fas fa-download"></i> Télécharger le document
                        </button>
                    </div>
                </div>
            `;
        }
    };

    // 22. TÉLÉCHARGEMENT DE FICHIER
    window.downloadFile = function(url, fileName) {
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // 23. SUPPRESSION D'UN COMMUNIQUÉ PAR FICHIER
    window.deleteFileCommunique = async function(communiqueId) {
        if (!confirm('Êtes-vous sûr de vouloir supprimer ce communiqué ? Cette action est irréversible.')) {
            return;
        }
        
        try {
            const communique = cache.fileCommuniques.find(c => c.id === communiqueId);
            if (!communique) {
                showAlert('Communiqué non trouvé.', 'error');
                return;
            }
            
            // 1. Supprimer de Firestore
            await deleteDoc(doc(db, 'file_communiques', communiqueId));
            
            // 2. Supprimer les relations parent-communiqué
            const relationsQuery = query(
                collection(db, 'parent_file_communique_relations'),
                where('communiqueId', '==', communiqueId)
            );
            const relationsSnap = await getDocs(relationsQuery);
            
            const batch = writeBatch(db);
            relationsSnap.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            
            // 3. Mettre à jour le cache
            cache.fileCommuniques = cache.fileCommuniques.filter(c => c.id !== communiqueId);
            
            // 4. Mettre à jour l'affichage
            if (document.getElementById('file-archive-table-body')) {
                displayFileCommuniques(cache.fileCommuniques);
                setupPagination(cache.fileCommuniques, 'file-archive-pagination');
            }
            
            showAlert('Communiqué supprimé avec succès.', 'success');
            
        } catch (error) {
            console.error('Erreur suppression communiqué:', error);
            showAlert('Erreur lors de la suppression: ' + error.message, 'error');
        }
    };

    // 24. NETTOYAGE DES COMMUNIQUÉS EXPIRÉS (incluant ceux par fichier)
    window.cleanupAllExpiredCommuniques = async function() {
        if (!confirm('Êtes-vous sûr de vouloir nettoyer TOUS les communiqués expirés ? Cette action est irréversible.')) {
            return;
        }
        
        try {
            showAlert('Nettoyage des communiqués expirés en cours...', 'info');
            
            const now = new Date().toISOString();
            let totalDeleted = 0;
            
            // 1. Nettoyer les communiqués standard
            const communiquesQuery = query(
                collection(db, 'communiques'),
                where('expirationDate', '<=', now)
            );
            
            const communiquesSnap = await getDocs(communiquesQuery);
            
            for (const communiqueDoc of communiquesSnap.docs) {
                await deleteExpiredCommunique(communiqueDoc.id);
                totalDeleted++;
            }
            
            // 2. Nettoyer les communiqués par fichier
            const fileCommuniquesQuery = query(
                collection(db, 'file_communiques'),
                where('expirationDate', '<=', now)
            );
            
            const fileCommuniquesSnap = await getDocs(fileCommuniquesQuery);
            
            for (const fileCommuniqueDoc of fileCommuniquesSnap.docs) {
                await deleteDoc(doc(db, 'file_communiques', fileCommuniqueDoc.id));
                
                // Supprimer aussi les relations
                const relationsQuery = query(
                    collection(db, 'parent_file_communique_relations'),
                    where('communiqueId', '==', fileCommuniqueDoc.id)
                );
                
                const relationsSnap = await getDocs(relationsQuery);
                const batch = writeBatch(db);
                relationsSnap.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                totalDeleted++;
            }
            
            // 3. Mettre à jour le cache
            cache.communiques = cache.communiques.filter(c => 
                !c.expirationDate || new Date(c.expirationDate) > new Date()
            );
            
            cache.fileCommuniques = cache.fileCommuniques.filter(c => 
                !c.expirationDate || new Date(c.expirationDate) > new Date()
            );
            
            // 4. Mettre à jour l'affichage
            if (document.getElementById('archive-table-body')) {
                displayCommuniques(cache.communiques);
                setupPagination(cache.communiques, 'archive-pagination');
            }
            
            if (document.getElementById('file-archive-table-body')) {
                displayFileCommuniques(cache.fileCommuniques);
                setupPagination(cache.fileCommuniques, 'file-archive-pagination');
            }
            
            showAlert(`✅ Nettoyage terminé: ${totalDeleted} communiqué(s) expiré(s) supprimé(s)`, 'success');
            
        } catch (error) {
            console.error('❌ Erreur nettoyage communiqués:', error);
            showAlert('Erreur lors du nettoyage: ' + error.message, 'error');
        }
    };

    // 25. GESTION DES ONGLETS
    document.querySelectorAll('.tabs .tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.dataset.tab;
            const parentTabs = tab.closest('.tabs');
            
            // Désactiver tous les onglets dans ce groupe
            parentTabs.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
            
            // Activer l'onglet sélectionné
            tab.classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Si on change d'onglet dans la page communication, charger les classes appropriées
            if (tab.closest('#communication-page')) {
                if (tabId === 'file') {
                    loadClassesForFileCommunique();
                } else if (tabId === 'standard') {
                    loadClassesForCommunique();
                }
            }
            
            // Si on change d'onglet dans les archives, charger les données appropriées
            if (tab.closest('#archive-page')) {
                if (tabId === 'file-communiques') {
                    displayFileCommuniques(cache.fileCommuniques);
                    setupPagination(cache.fileCommuniques, 'file-archive-pagination');
                } else if (tabId === 'communiques') {
                    displayCommuniques(cache.communiques);
                    setupPagination(cache.communiques, 'archive-pagination');
                } else if (tabId === 'salaries') {
                    // Les sous-onglets salaires seront gérés séparément
                }
            }
        });
    });

    // 26. GESTION DES SOUS-ONGLETS SALARIES
    document.querySelectorAll('#archive-page .tab[data-tab="archive-teachers"], #archive-page .tab[data-tab="archive-workers"]').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.dataset.tab;
            const parentDiv = tab.closest('.tab-content');
            
            parentDiv.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        });
    });

    // 27. FONCTION POUR CHARGER LES CLASSES POUR LES COMMUNIQUÉS STANDARD
    async function loadClassesForCommunique() {
        const container = document.getElementById('communique-classes-container');
        container.innerHTML = 'Chargement des classes...';
        
        try {
            const [classesSnap, primaryClassesSnap, kindergartenClassesSnap] = await Promise.all([
                getDocs(collection(db, 'classes')),
                getDocs(collection(db, 'primary_classes')),
                getDocs(collection(db, 'kindergarten_classes'))
            ]);
            
            let html = '';
            
            classesSnap.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="month-checkbox">
                        <input type="checkbox" id="class-${doc.id}" value="${data.name}" class="class-checkbox">
                        <label for="class-${doc.id}">${data.name} (Sec)</label>
                    </div>
                `;
            });
            
            primaryClassesSnap.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="month-checkbox">
                        <input type="checkbox" id="primary-class-${doc.id}" value="${data.name}" class="class-checkbox">
                        <label for="primary-class-${doc.id}">${data.name} (Prim)</label>
                    </div>
                `;
            });
            
            kindergartenClassesSnap.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="month-checkbox">
                        <input type="checkbox" id="kindergarten-class-${doc.id}" value="${data.name}" class="class-checkbox">
                        <label for="kindergarten-class-${doc.id}">${data.name} (Mat)</label>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p>Aucune classe disponible</p>';
            
        } catch (error) {
            console.error("Erreur chargement classes:", error);
            container.innerHTML = 'Erreur de chargement';
        }
    }

    // 28. FERMER LES MODALS
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
        });
    });

    // 29. FERMER LES MODALS EN CLIQUANT À L'EXTÉRIEUR
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
    });

    // 30. NAVIGATION ENTRE LES PAGES
    document.querySelectorAll('.nav-menu a').forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
            link.classList.add('active');
            document.getElementById(link.dataset.page + '-page').classList.add('active');
            document.getElementById('page-title').textContent = link.textContent;
            
            // Fermer le menu sur mobile
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.add('collapsed');
            }
        });
    });

    // 31. MENU BURGER POUR MOBILE
    document.getElementById('menu-toggle').addEventListener('click', () => {
        document.querySelector('.sidebar').classList.toggle('collapsed');
    });

    // 32. FERMER LE MENU EN CLIQUANT À L'EXTÉRIEUR (MOBILE)
    document.addEventListener('click', (e) => {
        const sidebar = document.querySelector('.sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        
        if (window.innerWidth <= 768 && 
            !sidebar.contains(e.target) && 
            !menuToggle.contains(e.target) &&
            !sidebar.classList.contains('collapsed')) {
            sidebar.classList.add('collapsed');
        }
    });

    // --- FONCTIONS EXISTANTES (à adapter si nécessaire) ---
    
    // Fonction pour charger les personnels ouvriers
    async function loadWorkers() {
        try {
            const workersSnap = await getDocs(collection(db, 'workers'));
            cache.workers = [];
            workersSnap.forEach(doc => {
                cache.workers.push({ id: doc.id, ...doc.data() });
            });
            
            displayWorkers(cache.workers);
            setupWorkerSearch();
            
        } catch (error) {
            console.error("Erreur chargement personnel:", error);
            document.getElementById('workers-table-body').innerHTML = '<tr><td colspan="8" style="text-align: center;">Erreur de chargement</td></tr>';
        }
    }

    // Fonction pour afficher les personnels
    function displayWorkers(workers) {
        const tableBody = document.getElementById('workers-table-body');
        
        if (workers.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucun personnel inscrit.</td></tr>';
            return;
        }
        
        let html = '';
        workers.forEach(worker => {
            const photoHTML = worker.photoURL 
                ? `<img src="${worker.photoURL}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`
                : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user"></i></div>';
            
            const statusBadge = worker.status === 'active' 
                ? '<span class="badge badge-success">Actif</span>' 
                : '<span class="badge badge-danger">Inactif</span>';
            
            html += `
                <tr>
                    <td>${worker.matricule}</td>
                    <td>${photoHTML}</td>
                    <td>${worker.fullName}</td>
                    <td>${worker.function}</td>
                    <td>${worker.phone}</td>
                    <td>${worker.hiredDate}</td>
                    <td>${statusBadge}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary" onclick="viewWorkerDetails('${worker.matricule}')">Détails</button>
                        <button class="btn btn-warning" onclick="editWorker('${worker.matricule}')">Modifier</button>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
    }

    // Fonction pour la recherche des personnels
    function setupWorkerSearch() {
        const searchInput = document.getElementById('worker-search');
        const statusFilter = document.getElementById('worker-status-filter');
        
        const updateTable = () => {
            const searchTerm = searchInput.value;
            const status = statusFilter.value;
            const filtered = filterWorkers(searchTerm, status);
            displayWorkers(filtered);
            setupPagination(filtered, 'workers-pagination');
        };
        
        searchInput.addEventListener('input', updateTable);
        statusFilter.addEventListener('change', updateTable);
    }

    // Fonction de filtrage des personnels
    function filterWorkers(searchTerm, statusFilter) {
        let filtered = cache.workers;
        
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(worker => 
                worker.matricule?.toLowerCase().includes(term) ||
                worker.fullName?.toLowerCase().includes(term) ||
                worker.function?.toLowerCase().includes(term) ||
                worker.phone?.toLowerCase().includes(term)
            );
        }
        
        if (statusFilter) {
            filtered = filtered.filter(worker => worker.status === statusFilter);
        }
        
        return filtered;
    }

    // Fonction de pagination
    function setupPagination(data, containerId, rowsPerPage = 10) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const totalPages = Math.ceil(data.length / rowsPerPage);
        
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
            html += `<button class="pagination-btn" data-page="${i}">${i}</button>`;
        }
        
        container.innerHTML = html;
        
        container.querySelectorAll('.pagination-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const page = parseInt(btn.dataset.page);
                showPage(data, page, rowsPerPage, containerId.replace('-pagination', '-table-body'));
                
                container.querySelectorAll('.pagination-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
        
        if (totalPages > 0) {
            showPage(data, 1, rowsPerPage, containerId.replace('-pagination', '-table-body'));
            container.querySelector('.pagination-btn').classList.add('active');
        }
    }

    function showPage(data, page, rowsPerPage, tableBodyId) {
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = data.slice(start, end);
        
        // Cette fonction devra être adaptée selon le type de données
        if (tableBodyId === 'workers-table-body') {
            displayWorkers(pageData);
        } else if (tableBodyId === 'archive-table-body') {
            displayCommuniques(pageData);
        } else if (tableBodyId === 'file-archive-table-body') {
            displayFileCommuniques(pageData);
        }
        // Ajouter d'autres cas selon les besoins
    }

    // 33. FONCTIONS POUR LES COMMUNIQUÉS STANDARD (existantes)
    
    // Charger les communiqués standard
    async function loadCommuniques() {
        try {
            const communiquesSnap = await getDocs(collection(db, 'communiques'));
            cache.communiques = [];
            communiquesSnap.forEach(doc => {
                cache.communiques.push({ id: doc.id, ...doc.data() });
            });
            
            // Trier par date
            cache.communiques.sort((a, b) => {
                const dateA = a.publishedAt?.toDate() || new Date(0);
                const dateB = b.publishedAt?.toDate() || new Date(0);
                return dateB - dateA;
            });
            
            displayCommuniques(cache.communiques);
            setupCommuniqueSearch();
            
        } catch (error) {
            console.error("Erreur chargement communiqués:", error);
        }
    }

    // Afficher les communiqués standard
    function displayCommuniques(communiques) {
        const tableBody = document.getElementById('archive-table-body');
        
        if (communiques.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucun communiqué publié.</td></tr>';
            return;
        }
        
        let html = '';
        communiques.forEach(data => {
            const publishedDate = data.publishedAt ? 
                new Date(data.publishedAt.toDate()).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Date inconnue';
            
            const statusBadge = data.status === 'published' 
                ? '<span class="badge badge-success">Publié</span>' 
                : '<span class="badge badge-warning">Brouillon</span>';
            
            html += `
                <tr>
                    <td>${publishedDate}</td>
                    <td>${data.feeType}</td>
                    <td>${data.month}</td>
                    <td>${data.schoolYear}</td>
                    <td>${data.classes?.join(', ') || ''}</td>
                    <td class="currency-display">$${data.amount?.toFixed(2) || '0.00'}</td>
                    <td>${statusBadge}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary" onclick="viewCommuniqueDetails('${data.id}')">Détails</button>
                        <button class="btn btn-info" onclick="reprintCommunique('${data.id}')">Réimprimer</button>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
    }

    // Recherche des communiqués standard
    function setupCommuniqueSearch() {
        const searchInput = document.getElementById('archive-search');
        const feeFilter = document.getElementById('archive-fee-filter');
        const yearFilter = document.getElementById('archive-year-filter');
        
        const updateTable = () => {
            const searchTerm = searchInput.value;
            const fee = feeFilter.value;
            const year = yearFilter.value;
            const filtered = filterCommuniques(searchTerm, fee, year);
            displayCommuniques(filtered);
            setupPagination(filtered, 'archive-pagination');
        };
        
        searchInput.addEventListener('input', updateTable);
        feeFilter.addEventListener('change', updateTable);
        yearFilter.addEventListener('change', updateTable);
    }

    // Filtrer les communiqués standard
    function filterCommuniques(searchTerm, feeFilter, yearFilter) {
        let filtered = cache.communiques;
        
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(com => 
                com.feeType?.toLowerCase().includes(term) ||
                com.month?.toLowerCase().includes(term) ||
                com.classes?.some(cls => cls.toLowerCase().includes(term))
            );
        }
        
        if (feeFilter) {
            filtered = filtered.filter(com => com.feeType === feeFilter);
        }
        
        if (yearFilter) {
            filtered = filtered.filter(com => com.schoolYear === yearFilter);
        }
        
        return filtered;
    }

    // 34. FONCTIONS POUR LES SALAIRES (existantes)
    
    async function loadTeacherSalaries() {
        try {
            const salariesSnap = await getDocs(collection(db, 'teacher_salaries'));
            cache.teacherSalaries = [];
            salariesSnap.forEach(doc => {
                cache.teacherSalaries.push({ id: doc.id, ...doc.data() });
            });
            
            displayTeacherSalaries(cache.teacherSalaries);
            setupTeacherSalarySearch();
            
        } catch (error) {
            console.error("Erreur chargement salaires enseignants:", error);
        }
    }

    async function loadWorkerSalaries() {
        try {
            const salariesSnap = await getDocs(collection(db, 'worker_salaries'));
            cache.workerSalaries = [];
            salariesSnap.forEach(doc => {
                cache.workerSalaries.push({ id: doc.id, ...doc.data() });
            });
            
            displayWorkerSalaries(cache.workerSalaries);
            setupWorkerSalarySearch();
            
        } catch (error) {
            console.error("Erreur chargement salaires personnels:", error);
        }
    }

    // 35. EXPOSER LES FONCTIONS AU NIVEAU GLOBAL
    window.previewCommunique = previewCommunique;
    window.printCommunique = printCommunique;
    window.closePreview = closePreview;
    window.viewWorkerDetails = viewWorkerDetails;
    window.editWorker = editWorker;
    window.findTeacher = findTeacher;
    window.findWorkerForSalary = findWorkerForSalary;
    window.viewCommuniqueDetails = viewCommuniqueDetails;
    window.reprintCommunique = reprintCommunique;
    window.viewSalaryDetails = viewSalaryDetails;
    window.printSalaryReceipt = printSalaryReceipt;
    window.printWorkerCard = printWorkerCard;
    window.closeModal = function(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    };

    // 36. INITIALISATION AU CHARGEMENT DE LA PAGE
    document.addEventListener('DOMContentLoaded', function() {
        // Charger les classes pour le communiqué standard par défaut
        loadClassesForCommunique();
        
        // Initialiser le formulaire de publication par fichier
        loadClassesForFileCommunique();
    });

</script>
</body>
</html>